name: "Sync Paperpile to Notion"
description: "An unofficial CLI to sync your Paperpile Articles/Authors to Notion."
author: jmuchovej

branding:
  icon: book
  color: blue

inputs:
  references:
    description: "The path to your BibTeX containing the desired entries to sync"
    required: true
  token:
    description: "Your Notion Integration Token."
    required: true

runs:
  using: "composite"
  steps:
    - name: "Install `paperpile-notion`"
      shell: "bash"
      run: "npm install -g @jmuchovej/paperpile-notion"

    - name: "Download existing cache"
      uses: "dawidd6/action-download-artifact@v2"
      with:
        workflow: "sync.yml"
        name: "paperpile-cache"
        path: "~/.cache/paperpile-notion/"
        check_artifacts: true

    - name: "Sync local `{.config,.cache}` with `~/{.config,.cache}`"
      if: ${{ always() }}
      shell: bash
      run: |
        [ -d "$(pwd)/.cache" ] && rsync -a $(pwd)/.cache ${HOME}/
        [ -d "$(pwd)/.config" ] && rsync -a $(pwd)/.config ${HOME}/

    - name: "Sync Author's Database"
      if: ${{ always() }}
      shell: bash
      run: paperpile-notion authors:sync ${{ inputs.references }} -t ${{ inputs.token }}

    - name: "Sync Article's Database"
      if: ${{ always() }}
      shell: bash
      run: paperpile-notion articles:sync ${{ inputs.references }} -t ${{ inputs.token }}

    - name: "Clean Author's Database"
      if: ${{ always() }}
      shell: bash
      run: paperpile-notion authors:clean ${{ inputs.references }} -t ${{ inputs.token }}

    - name: "Clean Article's Database"
      if: ${{ always() }}
      shell: bash
      run: paperpile-notion articles:clean ${{ inputs.references }} -t ${{ inputs.token }}

    - name: "Upload existing cache"
      if: ${{ always() }}
      uses: "actions/download-artifact@v3"
      with:
        name: "paperpile-cache"
        path: "~/.cache/paperpile-notion/"
